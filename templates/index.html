<!DOCTYPE html>
<html>
<head>
  <title>Device Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; }
  </style>
</head>
<body>
  <h1>Devices on Map</h1>
  <div id="map"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Array to store markers (optional for better performance)
    let markers = [];

    // Connect to Flask-SocketIO server
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // Handle incoming device updates
    socket.on('devices_response', function(devices) {
        console.log("hi")
      // Clear existing markers from the map (optional for efficiency)
      if (markers.length > 0) {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
      }

      // Add new markers to the map
      devices.forEach(device => {
        const marker = L.marker([device.latitude, device.longitude])
          .bindPopup("<b>" + device.name + "</b><br>Status: " + device.status)
          .addTo(map);
        markers.push(marker); // Add marker to the array for future removal (optional)
      });
    });

    // Request initial devices (optional)
    socket.emit('get_devices');
  </script>
</body>
</html>
